<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Airdrop Dream Calculator V2</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #0f0f13;
            color: #ffffff;
            font-family: 'Courier New', monospace;
            min-height: 100vh;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2.5rem;
            color: #8A2BE2;
            text-transform: uppercase;
            letter-spacing: 3px;
            margin-bottom: 10px;
        }

        .version-badge {
            display: inline-block;
            background: rgba(138, 43, 226, 0.3);
            border: 1px solid #8A2BE2;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            color: #8A2BE2;
        }

        /* Onglets */
        .tabs {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 40px;
            border-bottom: 2px solid #333;
            padding-bottom: 10px;
        }

        .tab-button {
            background: transparent;
            border: none;
            color: #888;
            font-family: 'Courier New', monospace;
            font-size: 1.1rem;
            padding: 10px 30px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 2px;
            position: relative;
        }

        .tab-button:hover {
            color: #8A2BE2;
        }

        .tab-button.active {
            color: #8A2BE2;
        }

        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -12px;
            left: 0;
            right: 0;
            height: 2px;
            background: #8A2BE2;
        }

        /* Contenu des onglets */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: rgba(20, 20, 28, 0.8);
            border: 1px solid #8A2BE2;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 0 40px rgba(138, 43, 226, 0.3);
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #bbb;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        input, select {
            width: 100%;
            padding: 15px;
            background: #1a1a24;
            border: 1px solid #333;
            border-radius: 8px;
            color: #fff;
            font-family: 'Courier New', monospace;
            font-size: 1.1rem;
            transition: all 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #8A2BE2;
            box-shadow: 0 0 10px rgba(138, 43, 226, 0.5);
        }

        select {
            cursor: pointer;
        }

        .btn-primary {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #8A2BE2 0%, #6a1bb2 100%);
            border: none;
            border-radius: 8px;
            color: #fff;
            font-family: 'Courier New', monospace;
            font-size: 1.1rem;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 25px rgba(138, 43, 226, 0.6);
        }

        .btn-primary:disabled {
            background: #333;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .results {
            margin-top: 40px;
            padding: 30px;
            background: #1a1a24;
            border: 2px solid #8A2BE2;
            border-radius: 8px;
            display: none;
        }

        .results.show {
            display: block;
        }

        .result-item {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #333;
        }

        .result-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .result-label {
            color: #888;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }

        .result-value {
            font-size: 1.8rem;
            color: #00ff88;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }

        .result-value.big {
            font-size: 2.5rem;
        }

        /* Battle Chart */
        .battle-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-container {
            position: relative;
            height: 500px;
            margin-top: 30px;
            background: #1a1a24;
            border-radius: 8px;
            padding: 20px;
            display: none;
        }

        .chart-container.show {
            display: block;
        }

        .loading {
            text-align: center;
            color: #8A2BE2;
            margin-top: 20px;
            display: none;
        }

        .loading.show {
            display: block;
        }

        .error {
            background: rgba(255, 50, 50, 0.2);
            border: 1px solid #ff3232;
            color: #ff8888;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            text-align: center;
            display: none;
        }

        .error.show {
            display: block;
        }

        .crypto-option {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .crypto-logo {
            width: 24px;
            height: 24px;
            border-radius: 50%;
        }

        @media (max-width: 768px) {
            h1 { font-size: 1.8rem; }
            .tabs { flex-direction: column; gap: 10px; }
            .battle-controls { grid-template-columns: 1fr; }
            .chart-container { height: 350px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üöÄ Airdrop Dream Calculator</h1>
        <span class="version-badge">V2.0 - Battle Chart Edition</span>
    </div>

    <!-- Onglets -->
    <div class="tabs">
        <button class="tab-button active" onclick="switchTab('calculator')">üí∞ Calculateur</button>
        <button class="tab-button" onclick="switchTab('battle')">‚öîÔ∏è Battle Chart</button>
    </div>

    <!-- Onglet 1: Calculateur -->
    <div id="tab-calculator" class="tab-content active">
        <div class="container">
            <div class="form-group">
                <label for="myProject">Mon Projet (Optionnel - Auto-remplissage)</label>
                <select id="myProject" onchange="fillSupply()">
                    <option value="">-- Saisie manuelle --</option>
                </select>
            </div>

            <div class="form-group">
                <label for="tokenAmount">Mon Nombre de Tokens</label>
                <input type="number" id="tokenAmount" placeholder="Ex: 1000" min="0" step="any">
            </div>

            <div class="form-group">
                <label for="totalSupply">Total Supply du Projet</label>
                <input type="number" id="totalSupply" placeholder="Ex: 1000000000" min="0" step="any">
            </div>

            <div class="form-group">
                <label for="targetProject">Projet Cible (Market Cap de r√©f√©rence)</label>
                <select id="targetProject">
                    <option value="">-- Choisis un g√©ant --</option>
                </select>
            </div>

            <button class="btn-primary" onclick="calculateDream()">Calculer Mon R√™ve</button>

            <div class="loading" id="loadingCalc">‚è≥ Calcul en cours...</div>
            <div class="error" id="errorCalc"></div>

            <div class="results" id="results">
                <div class="result-item">
                    <div class="result-label">Prix R√™v√© par Token</div>
                    <div class="result-value" id="dreamPrice">$0.00</div>
                </div>
                <div class="result-item">
                    <div class="result-label">Valeur de Mon Bag üí∞</div>
                    <div class="result-value big" id="bagValue">$0.00</div>
                </div>
                <div class="result-item">
                    <div class="result-label">Market Cap Cible</div>
                    <div class="result-value" id="targetMcap">$0</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Onglet 2: Battle Chart -->
    <div id="tab-battle" class="tab-content">
        <div class="container">
            <h2 style="color: #8A2BE2; margin-bottom: 30px; text-align: center;">BATTLE CHART - COMPARAISON 1 AN</h2>
            
            <div class="battle-controls">
                <div class="form-group">
                    <label for="tokenA">Token A</label>
                    <select id="tokenA">
                        <option value="">-- Choisis Token A --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="tokenB">Token B</label>
                    <select id="tokenB">
                        <option value="">-- Choisis Token B --</option>
                    </select>
                </div>
            </div>

            <button class="btn-primary" onclick="compareBattle()">‚öîÔ∏è Lancer la Bataille</button>

            <div class="loading" id="loadingBattle">‚è≥ Chargement des donn√©es historiques...</div>
            <div class="error" id="errorBattle"></div>

            <div class="chart-container" id="chartContainer">
                <canvas id="battleChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const SUPABASE_URL = 'https://fxdkyfqklrxumqpxcatp.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ4ZGt5ZnFrbHJ4dW1xcHhjYXRwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NTgxNzcsImV4cCI6MjA4NDMzNDE3N30.UpOivYpJVHOow6Fm1jRqENt8N1u3gNMRneXzmNmfz4U';

        let cryptoData = [];
        let battleChart = null;

        // Charger les donn√©es
        async function loadCryptoData() {
            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/crypto_prices?select=*&order=market_cap.desc`,
                    {
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`
                        }
                    }
                );

                cryptoData = await response.json();
                populateDropdowns();
            } catch (error) {
                console.error('Erreur:', error);
            }
        }

        // Remplir les menus d√©roulants
        function populateDropdowns() {
            const selects = ['myProject', 'targetProject', 'tokenA', 'tokenB'];
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                const isFirstOption = select.children.length === 1;
                
                cryptoData.forEach(crypto => {
                    const option = document.createElement('option');
                    option.value = crypto.coin_id;
                    option.textContent = `${crypto.name} (${crypto.symbol})`;
                    if (selectId.includes('target') || selectId.includes('token')) {
                        option.textContent += ` - ${formatNumber(crypto.market_cap, 0)}`;
                    }
                    select.appendChild(option);
                });
            });
        }

        // Changer d'onglet
        function switchTab(tabName) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        // Auto-remplir le Total Supply
        function fillSupply() {
            const coinId = document.getElementById('myProject').value;
            if (coinId) {
                const crypto = cryptoData.find(c => c.coin_id === coinId);
                if (crypto) {
                    document.getElementById('totalSupply').value = crypto.total_supply;
                }
            } else {
                document.getElementById('totalSupply').value = '';
            }
        }

        // Calculer (Onglet 1)
        async function calculateDream() {
            document.getElementById('errorCalc').classList.remove('show');
            document.getElementById('results').classList.remove('show');

            const tokenAmount = parseFloat(document.getElementById('tokenAmount').value);
            const totalSupply = parseFloat(document.getElementById('totalSupply').value);
            const targetCoinId = document.getElementById('targetProject').value;

            if (!tokenAmount || tokenAmount <= 0) {
                showError('errorCalc', '‚ö†Ô∏è Entre un nombre de tokens valide');
                return;
            }

            if (!totalSupply || totalSupply <= 0) {
                showError('errorCalc', '‚ö†Ô∏è Entre un Total Supply valide');
                return;
            }

            if (!targetCoinId) {
                showError('errorCalc', '‚ö†Ô∏è Choisis un projet cible');
                return;
            }

            document.getElementById('loadingCalc').classList.add('show');

            try {
                const targetCrypto = cryptoData.find(c => c.coin_id === targetCoinId);
                const dreamPrice = targetCrypto.market_cap / totalSupply;
                const bagValue = dreamPrice * tokenAmount;

                document.getElementById('dreamPrice').textContent = formatPrice(dreamPrice);
                document.getElementById('bagValue').textContent = formatPrice(bagValue);
                document.getElementById('targetMcap').textContent = formatNumber(targetCrypto.market_cap, 0) + ' (' + targetCrypto.name + ')';
                document.getElementById('results').classList.add('show');

            } catch (error) {
                showError('errorCalc', '‚ùå Erreur: ' + error.message);
            } finally {
                document.getElementById('loadingCalc').classList.remove('show');
            }
        }

        // Battle Chart (Onglet 2)
        async function compareBattle() {
            const tokenAId = document.getElementById('tokenA').value;
            const tokenBId = document.getElementById('tokenB').value;

            if (!tokenAId || !tokenBId) {
                showError('errorBattle', '‚ö†Ô∏è Choisis deux tokens √† comparer');
                return;
            }

            if (tokenAId === tokenBId) {
                showError('errorBattle', '‚ö†Ô∏è Choisis deux tokens diff√©rents');
                return;
            }

            document.getElementById('errorBattle').classList.remove('show');
            document.getElementById('chartContainer').classList.remove('show');
            document.getElementById('loadingBattle').classList.add('show');

            try {
                // R√©cup√©rer les donn√©es historiques
                const [dataA, dataB] = await Promise.all([
                    fetch(`https://api.coingecko.com/api/v3/coins/${tokenAId}/market_chart?vs_currency=usd&days=365`).then(r => r.json()),
                    fetch(`https://api.coingecko.com/api/v3/coins/${tokenBId}/market_chart?vs_currency=usd&days=365`).then(r => r.json())
                ]);

                const tokenA = cryptoData.find(c => c.coin_id === tokenAId);
                const tokenB = cryptoData.find(c => c.coin_id === tokenBId);

                drawBattleChart(dataA, dataB, tokenA, tokenB);

            } catch (error) {
                showError('errorBattle', '‚ùå Erreur API CoinGecko. R√©essaie dans 1 minute.');
            } finally {
                document.getElementById('loadingBattle').classList.remove('show');
            }
        }

        // Dessiner le graphique
        function drawBattleChart(dataA, dataB, tokenA, tokenB) {
            const pricesA = dataA.prices;
            const pricesB = dataB.prices;

            // Normaliser en base 100
            const baseA = pricesA[0][1];
            const baseB = pricesB[0][1];

            const normalizedA = pricesA.map(p => ({
                x: new Date(p[0]),
                y: ((p[1] / baseA) * 100).toFixed(2)
            }));

            const normalizedB = pricesB.map(p => ({
                x: new Date(p[0]),
                y: ((p[1] / baseB) * 100).toFixed(2)
            }));

            // D√©truire l'ancien graphique
            if (battleChart) {
                battleChart.destroy();
            }

            const ctx = document.getElementById('battleChart').getContext('2d');
            battleChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: `${tokenA.name} (${tokenA.symbol})`,
                            data: normalizedA,
                            borderColor: '#8A2BE2',
                            backgroundColor: 'rgba(138, 43, 226, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            pointRadius: 0
                        },
                        {
                            label: `${tokenB.name} (${tokenB.symbol})`,
                            data: normalizedB,
                            borderColor: '#00ff88',
                            backgroundColor: 'rgba(0, 255, 136, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#fff',
                                font: { size: 14, family: 'Courier New' }
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: '#8A2BE2',
                            bodyColor: '#fff',
                            borderColor: '#8A2BE2',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'month' },
                            grid: { color: '#222' },
                            ticks: { color: '#888' }
                        },
                        y: {
                            grid: { color: '#222' },
                            ticks: {
                                color: '#888',
                                callback: function(value) {
                                    return value + '%';
                                }
                            },
                            title: {
                                display: true,
                                text: 'Performance (Base 100)',
                                color: '#8A2BE2'
                            }
                        }
                    }
                }
            });

            document.getElementById('chartContainer').classList.add('show');
        }

        // Utilitaires
        function showError(id, message) {
            const errorDiv = document.getElementById(id);
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
            setTimeout(() => errorDiv.classList.remove('show'), 5000);
        }

        function formatPrice(value) {
            if (value >= 1) {
                return '$' + value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            } else if (value >= 0.01) {
                return '$' + value.toFixed(4);
            } else {
                return '$' + value.toFixed(8);
            }
        }

        function formatNumber(value, decimals = 0) {
            if (value >= 1000000000) {
                return '$' + (value / 1000000000).toFixed(2) + 'B';
            } else if (value >= 1000000) {
                return '$' + (value / 1000000).toFixed(2) + 'M';
            } else {
                return '$' + value.toLocaleString('en-US', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
            }
        }

        // Charger au d√©marrage
        loadCryptoData();
    </script>
</body>
</html>
